<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>‡∏à‡∏≠‡∏á‡∏´‡πâ‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">


    <!-- FULLCALENDAR v5 ‡πÅ‡∏ö‡∏ö‡∏á‡πà‡∏≤‡∏¢ -->
    <link href="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js"></script>

</head>

<body class="bg-light">

        <div class="container-fluid px-3 py-3">
            <h4 class="text-center mb-1">üìÖ ‡∏à‡∏≠‡∏á‡∏´‡πâ‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°</h4>

            <div class="row g-1">
                <div class="col-12 col-md-4">
                    <label class="form-label">‡∏´‡πâ‡∏≠‡∏á</label>
                    <select id="room" class="form-select" aria-placeholder="‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡πâ‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏°">
                        <option>‡∏´‡πâ‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏° 1</option>
                        <option>‡∏´‡πâ‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏° 2</option>
                        <option>‡∏´‡πâ‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏° 3</option>
                        <option>‡∏´‡πâ‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏° 4</option>
                        <option>‡∏´‡πâ‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏° 5</option>
                        <option>‡∏´‡πâ‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏° 6</option>
                        <option>‡∏´‡πâ‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏° 7</option>
                    </select>
                </div>
                <div class="col-6 col-md-4">
                    <label class="form-label">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
                    <input type="date" id="startDate" class="form-control" />
                </div>
                <div class="col-3 col-md-2">
                    <label class="form-label">‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°</label>
                    <select id="startTime" class="form-select" onchange="adjustEndTime()"></select>
                </div>
                <div class="col-3 col-md-2">
                    <label class="form-label">‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î</label>
                    <select id="endTime" class="form-select"></select>
                </div>

                <div class="col-12 col-md-6">
                    <label class="form-label">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏à‡∏≠‡∏á</label>
                    <input type="text" id="booker" class="form-control" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏à‡∏≠‡∏á" />
                </div>
                <div class="col-12 col-md-6">
                    <label class="form-label">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</label>
                    <textarea id="note" class="form-control" rows="2" placeholder="‡∏£‡∏∞‡∏ö‡∏∏‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°‡∏ñ‡πâ‡∏≤‡∏°‡∏µ..."></textarea>
                </div>

                <div class="col-12 d-flex gap-2 mt-1">
                    <button onclick="book()"
                        class="btn btn-primary w-100 d-flex justify-content-center align-items-center gap-2">
                        <i class="bi bi-check-circle-fill"></i> ‡∏à‡∏≠‡∏á
                    </button>
                </div>
            </div>

            <div id="calendar" class="mt-4"></div>
        </div>

        <!-- Modal -->
        <div class="modal fade" id="eventModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header bg-primary text-white">
                        <h5 class="modal-title">üìå ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="border-start border-4 ps-3" id="modalDetails"></div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-danger" onclick="cancelBooking()">‚ùå ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á</button>
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">‡∏õ‡∏¥‡∏î</button>
                    </div>
                </div>
            </div>
        </div>

        <script>
            // ‚úÖ ‡πÅ‡∏Å‡πâ‡πÄ‡∏õ‡πá‡∏ô:
            // ‚úÖ ‡πÉ‡∏ä‡πâ path /meeting-ws/ ‡πÅ‡∏¢‡∏Å‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô
            const wsProtocol = location.protocol === 'https:' ? 'wss://' : 'ws://';
            const ws = new WebSocket(`${wsProtocol}${location.host}/meeting-ws/`);
            let calendar;
            let bookings = [];
            let selectedBookingId = null;

            ws.onmessage = (event) => {
                const data = JSON.parse(event.data);
                if (data.type === "init") {
                    bookings = data.bookings;
                    renderCalendar(true);
                } else if (data.type === "booked") {
                    bookings.push(data.booking);
                    renderCalendar();
                    Swal.fire({ toast: true, icon: "success", title: "‡∏à‡∏≠‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à", position: "top-end", showConfirmButton: false, timer: 2000 });
                } else if (data.type === "cancelled") {
                    bookings = bookings.filter((b) => b.id !== data.id);
                    renderCalendar();
                    Swal.fire({ toast: true, icon: "info", title: "‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à", position: "top-end", showConfirmButton: false, timer: 2000 });
                } else if (data.type === "error") {
                    Swal.fire({ toast: true, icon: "error", title: data.message, position: "top-end", showConfirmButton: false, timer: 2500 });
                }
            };

            function generateTimeOptions(startHour = 8, endHour = 17) {
                const options = [];
                for (let h = startHour; h <= endHour; h++) {
                    for (let m of [0, 30]) {
                        const hour = h.toString().padStart(2, "0");
                        const min = m.toString().padStart(2, "0");
                        options.push(`${hour}:${min}`);
                    }
                }
                return options;
            }

            function populateTimeDropdowns() {
                const startSel = document.getElementById("startTime");
                const endSel = document.getElementById("endTime");
                const options = generateTimeOptions();
                startSel.innerHTML = "";
                endSel.innerHTML = "";
                for (let time of options) {
                    startSel.innerHTML += `<option value="${time}">${time}</option>`;
                    endSel.innerHTML += `<option value="${time}">${time}</option>`;
                }
            }

            function adjustEndTime() {
                const start = document.getElementById("startTime").value;
                const endSel = document.getElementById("endTime");
                const options = Array.from(endSel.options);
                for (let opt of options) {
                    opt.disabled = opt.value <= start;
                }
                if (endSel.value <= start) {
                    const next = options.find((o) => o.value > start && !o.disabled);
                    if (next) endSel.value = next.value;
                }
            }

            function book() {
                const room = document.getElementById("room").value;
                const date = document.getElementById("startDate").value;
                const timeStart = document.getElementById("startTime").value;
                const timeEnd = document.getElementById("endTime").value;
                const note = document.getElementById("note").value;
                const booker = document.getElementById("booker").value;

                if (!date || !timeStart || !timeEnd || !booker.trim()) {
                    Swal.fire({ icon: "warning", text: "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö" });
                    return;
                }
                if (timeEnd <= timeStart) {
                    Swal.fire({ icon: "warning", text: "‡πÄ‡∏ß‡∏•‡∏≤‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°" });
                    return;
                }

                const start = new Date(`${date}T${timeStart}`);
                const end = new Date(`${date}T${timeEnd}`);
                if (start.toDateString() !== end.toDateString()) {
                    Swal.fire({ icon: "warning", text: "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏à‡∏≠‡∏á‡∏Ç‡πâ‡∏≤‡∏°‡∏ß‡∏±‡∏ô‡πÑ‡∏î‡πâ" });
                    return;
                }

                ws.send(JSON.stringify({ type: "book", room, start: start.toISOString(), end: end.toISOString(), note, booker }));

                document.getElementById("room").value = "‡∏´‡πâ‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏° 1";
                document.getElementById("note").value = "";
                document.getElementById("booker").value = "";
                const today = new Date().toISOString().split("T")[0];
                document.getElementById("startDate").value = today;
                populateTimeDropdowns();
                adjustEndTime();
            }

            function clearAll() {
                if (confirm("‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡πâ‡∏≤‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î?")) {
                    ws.send(JSON.stringify({ type: "clear_all" }));
                }
            }

            const roomColor = (roomName) => {
                switch (roomName) {
                    case "‡∏´‡πâ‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏° 1":
                        return "#f44336"; // ‡πÅ‡∏î‡∏á‡∏û‡∏≤‡∏™‡πÄ‡∏ó‡∏•‡πÄ‡∏Ç‡πâ‡∏°
                    case "‡∏´‡πâ‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏° 2":
                        return "#2196f3"; // ‡∏ü‡πâ‡∏≤‡∏ô‡πâ‡∏≥‡∏ó‡∏∞‡πÄ‡∏•
                    case "‡∏´‡πâ‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏° 3":
                        return "#ff9800"; // ‡∏™‡πâ‡∏°‡πÄ‡∏Ç‡πâ‡∏°
                    case "‡∏´‡πâ‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏° 4":
                        return "#4caf50"; // ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß‡∏™‡∏î
                    case "‡∏´‡πâ‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏° 5":
                        return "#9c27b0"; // ‡∏°‡πà‡∏ß‡∏á‡∏™‡∏î
                    case "‡∏´‡πâ‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏° 6":
                        return "#00bcd4"; // ‡∏ü‡πâ‡∏≤‡∏≠‡∏°‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß
                    case "‡∏´‡πâ‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡∏ä‡∏∏‡∏° 7":
                        return "#ffc107"; // ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á‡∏≠‡∏°‡∏ô‡πâ‡∏≥‡∏ï‡∏≤‡∏•
                    default:
                        return "#607d8b"; // ‡∏™‡∏µ‡πÄ‡∏ó‡∏≤‡∏ô‡πâ‡∏≥‡πÄ‡∏á‡∏¥‡∏ô
                }
            };

            function renderCalendar(forceClear = false) {
                const events = bookings.map((b) => ({
                    id: b.id,
                    title: `‡∏Ñ‡∏∏‡∏ì ${b.booker || "‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏"}`,
                    start: b.start,
                    end: b.end,
                    color: roomColor(b.room),
                    extendedProps: { note: b.note, booker: b.booker, room: b.room }
                }));

                if (calendar && forceClear) {
                    calendar.getEventSources().forEach((src) => src.remove());
                }

                if (calendar) {
                    calendar.removeAllEvents();
                    calendar.addEventSource(events);
                    return;
                }

                calendar = new FullCalendar.Calendar(document.getElementById("calendar"), {
                    initialView: "timeGridWeek",
                    headerToolbar: {
                        left: "prev,next today",
                        center: "title",
                        right: "timeGridDay,timeGridWeek"
                    },
                    slotMinTime: "08:00:00",
                    slotMaxTime: "17:00:00",
                    allDaySlot: false,
                    locale: "th",
                    height: "auto",
                    events,
                    eventClick: function (info) {
                        openModal(info.event);
                    }
                });

                calendar.render();
            }

            function openModal(event) {
                selectedBookingId = parseInt(event.id);
                const note = event.extendedProps.note || "-";
                const booker = event.extendedProps.booker || "-";
                const room = event.extendedProps.room || "-";
                const start = new Date(event.start).toLocaleString();
                const end = new Date(event.end).toLocaleString();

                document.getElementById("modalDetails").innerHTML = `
        <p>üßç‚Äç‚ôÇ <strong>‡∏ú‡∏π‡πâ‡∏à‡∏≠‡∏á:</strong> ${booker}</p>
        <p>üè¢ <strong>‡∏´‡πâ‡∏≠‡∏á:</strong> ${room}</p>
        <p>üïí <strong>‡πÄ‡∏ß‡∏•‡∏≤:</strong> ${start} - ${end}</p>
        <p>üìù <strong>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏:</strong> ${note}</p>
      `;

                new bootstrap.Modal(document.getElementById("eventModal")).show();
            }

            function cancelBooking() {
                if (selectedBookingId) {
                    ws.send(JSON.stringify({ type: "cancel", id: selectedBookingId }));
                }
                bootstrap.Modal.getInstance(document.getElementById("eventModal")).hide();
            }

            window.onload = () => {
                const today = new Date().toISOString().split("T")[0];
                document.getElementById("startDate").value = today;
                document.getElementById("startDate").min = today;
                populateTimeDropdowns();
                adjustEndTime();
            };
        </script>
    </body>

</html>